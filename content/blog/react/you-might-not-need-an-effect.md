---
title: C√≥ th·ªÉ b·∫°n kh√¥ng c·∫ßn ƒë·∫øn Effect
description: C·∫©m nang `useEffect` ƒë√∫ng c√°ch trong React
draft: false
date: 2022-08-15 22:32:08
categories:
  - L·∫≠p tr√¨nh
tags:
  - javascript
  - reactjs
  - new-reactjs-docs
  - useEffect
---

Hi·ªáu ·ª©ng hay h·ªá qu·∫£ c√≥ th·ªÉ ƒë·∫øn sau ho·∫∑c kh√¥ng, nh∆∞ng nguy√™n nh√¢n th√¨ ch·∫Øc ch·∫Øn ƒë·∫øn tr∆∞·ªõc.

<!--more-->

Effect c√≥ vai tr√≤ nh∆∞ m·ªôt c·ª≠a tho√°t hi·ªÉm trong m√¥ h√¨nh c·ªßa React. Ch√∫ng cho ph√©p b·∫°n "b∆∞·ªõc ra ngo√†i" React v√† ƒë·ªìng b·ªô c√°c component v·ªõi c√°c h·ªá th·ªëng b√™n ngo√†i nh∆∞ giao ti·∫øp c√°c th∆∞ vi·ªán b√™n th·ª© ba, v·ªõi m·∫°ng hay v·ªõi DOM. N·∫øu component kh√¥ng k·∫øt n·ªëi v·ªõi h·ªá th·ªëng ngo·∫°i lai n√†o kh√°c, _b·∫°n kh√¥ng n√™n s·ª≠ d·ª•ng Effect_. Lo·∫°i b·ªè c√°c Effect kh√¥ng c·∫ßn thi·∫øt gi√∫p code d·ªÖ theo d√µi logic, ch·∫°y nhanh v√† √≠t l·ªói h∆°n.

---

## L√†m th·∫ø n√†o ƒë·ªÉ lo·∫°i b·ªè Effect kh√¥ng c·∫ßn thi·∫øt

Hai tr∆∞·ªùng h·ª£p th∆∞·ªùng g·∫∑p m√† _b·∫°n kh√¥ng c·∫ßn d√πng ƒë·∫øn Effect_:

* __Kh√¥ng c·∫ßn Effect ƒë·ªÉ chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu cho render__. Ch·∫≥ng h·∫°n, b·∫°n mu·ªën l·ªçc m·ªôt danh s√°ch tr∆∞·ªõc m·ªói l·∫ßn hi·ªÉn th·ªã. B·∫°n c√≥ th·ªÉ th·∫•y h·∫•p d·∫´n v·ªõi √Ω t∆∞·ªüng vi·∫øt m·ªôt Effect ƒë·ªÉ c·∫≠p nh·∫≠t bi·∫øn state m·ªói khi danh s√°ch n√†y thay ƒë·ªïi. Tuy nhi√™n, l√†m v·∫≠y th·ª±c ra kh√¥ng hi·ªáu qu·∫£. M·ªói khi state c·ªßa component thay ƒë·ªïi, React tr∆∞·ªõc ti√™n s·∫Ω g·ªçi c√°c h√†m ƒë·ªÉ t√≠nh to√°n nh·ªØng g√¨ _s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã_, sau ƒë√≥ m·ªõi "commit" nh·ªØng thay ƒë·ªïi n√†y l√™n DOM. Ti·∫øp ƒë·∫øn React ch·∫°y c√°c Effect. N·∫øu Effect _l·∫°i ti·∫øp t·ª•c c·∫≠p nh·∫≠t state_, to√†n b·ªô qu√° tr√¨nh l·∫°i ch·∫°y l·∫°i t·ª´ ƒë·∫ßu. ƒê·ªÉ lo·∫°i b·ªè m·ªçi render th·ª´a, h√£y chuy·ªÉn ƒë·ªïi to√†n b·ªô d·ªØ li·ªáu _·ªü ngay ƒë·∫ßu component_. Nh·ªØng h√†m chuy·ªÉn ƒë·ªïi ƒë√≥ s·∫Ω t·ª± ƒë·ªông ch·∫°y l·∫°i m·ªói khi props hay state thay ƒë·ªïi.
* __Kh√¥ng c·∫ßn Effect ƒë·ªÉ x·ª≠ l√Ω event t·ª´ ng∆∞·ªùi d√πng__. Gi·∫£ d·ª• m·ªói khi ng∆∞·ªùi d√πng mua m·ªôt s·∫£n ph·∫©m, b·∫°n mu·ªën g·ª≠i m·ªôt request POST ƒë·∫øn `/api/buy` v√† hi·ªÉn th·ªã m·ªôt notification. M·ªçi x·ª≠ l√Ω n√™n ƒë∆∞·ª£c ƒë·∫∑t trong event handler t∆∞∆°ng ·ª©ng c·ªßa n√∫t "Mua", ch·ª© kh√¥ng ph·∫£i Effect.

Ch√∫ng ta h√£y t√¨m hi·ªÉu c√°c v√≠ d·ª• c·ª• th·ªÉ sau ƒë·ªÉ hi·ªÉu r√µ h∆°n.

### C·∫≠p nh·∫≠t state d·ª±a tr√™n props ho·∫∑c state

Gi·∫£ d·ª• b·∫°n c√≥ m·ªôt component v·ªõi 2 bi·∫øn state: `firstName` v√† `lastName`, v√† mu·ªën hi·ªÉn th·ªã t√™n ƒë·∫ßy ƒë·ªß `fullName` b·∫±ng c√°ch n·ªëi hai bi·∫øn tr√™n. `fullName` ph·∫£i t·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói `firstName` ho·∫∑c `lastName` thay ƒë·ªïi. Tr·ª±c gi√°c m√°ch b·∫£o b·∫°n n√™n c·∫≠p nh·∫≠t `fullName` trong m·ªôt Effect.

```jsx
function Form() {
  const [firstName, setFirstName] = useState('Taylor');
  const [lastName, setLastName] = useState('Swift');

  // üî¥ C·∫ßn tr√°nh: state v√† Effect kh√¥ng c·∫ßn thi·∫øt
  const [fullName, setFullName] = useState('');
  useEffect(() => {
    setFullName(firstName + ' ' + lastName);
  }, [firstName, lastName]);
  // ...
}
```

M·ªçi th·ª© c√≥ v·∫ª ph·ª©c t·∫°p h∆°n b√¨nh th∆∞·ªùng, v√† k√©m hi·ªáu qu·∫£ n·ªØa: to√†n b·ªô component ph·∫£i render khi khai b√°o state cho `fullName`, r·ªìi render ti·∫øp khi n√≥ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi Effect. H√£y xo√° c·∫£ state v√† Effect:

```js
function Form() {
  const [firstName, setFirstName] = useState('Taylor');
  const [lastName, setLastName] = useState('Swift');
  // ‚úÖ T·ªët: t√≠nh ngay khi render
  const fullName = firstName + ' ' + lastName;
  // ...
}
```

Khi th·ª© g√¨ ƒë√≥ c√≥ th·ªÉ ƒë∆∞·ª£c t√≠nh to√°n t·ª´ props ho·∫∑c state ƒë√£ t·ªìn t·∫°i, __ƒë·ª´ng t·∫°o state__. Thay v√†o ƒë√≥ hay t√≠nh to√°n khi render. ƒêi·ªÅu n√†y gi√∫p code nhanh h∆°n (lo·∫°i c√°c t√≠nh to√°n "ch·ªìng nhau"), ƒë∆°n gi·∫£n h∆°n (√≠t code h∆°n), v√† √≠t l·ªói h∆°n (tr√°nh ƒë∆∞·ª£c c√°c bug khi c√°c state kh√¥ng ƒë∆∞·ª£c ƒë·ªìng b·ªô v·ªõi nhau). N·∫øu ƒë√£ ƒë·ªçc ƒë∆∞·ª£c t·ªõi ƒë√¢y m√† m·ªçi th·ª© v·∫´n m√π m·ªãt, b·∫°n c√≥ th·ªÉ ph·∫£i d·ª´ng l·∫°i v√† h·ªçc c√°ch ["suy nghƒ© theo React"](https://beta.reactjs.org/learn/thinking-in-react#step-3-find-the-minimal-but-complete-representation-of-ui-state) tr∆∞·ªõc.

### Cache c√°c t√≠nh to√°n ph·ª©c t·∫°p

Ph·∫ßn tr√™n khuy√™n ta n√™n t√≠nh to√°n c√°c gi√° tr·ªã ngay khi render. V·∫≠y n·∫øu c√°c t√≠nh to√°n ƒë√≥ r·∫•t t·ªën t√†i nguy√™n th√¨ sao? Component `TodoList` sau t√≠nh to√°n `visibleTodos` b·∫±ng c√°ch ƒëem props `todos` ƒëi l·ªçc theo props `filter`. B·∫°n d·ªÖ b·ªã cu·ªën theo suy nghƒ© l∆∞u k·∫øt qu·∫£ t√≠nh to√°n v√†o state v√† update trong Effect:

```jsx
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');

  // üî¥ C·∫ßn tr√°nh: state v√† Effect kh√¥ng c·∫ßn thi·∫øt
  const [visibleTodos, setVisibleTodos] = useState([]);
  useEffect(() => {
    setVisibleTodos(getFilteredTodos(todos, filter));
  }, [todos, filter]);

  // ...
}
```

Gi·ªëng nh∆∞ v√≠ d·ª• tr∆∞·ªõc, c√°ch l√†m n√†y v·ª´a th·ª´a v·ª´a ph√≠. ƒê·∫ßu ti√™n, c·∫ßn lo·∫°i b·ªè state v√† Effect:

```jsx
function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  // ‚úÖ ·ªîn n·∫øu getFilteredTodos() nhanh.
  const visibleTodos = getFilteredTodos(todos, filter);
  // ...
}
```

Code tr√™n s·∫Ω g·∫∑p v·∫•n ƒë·ªÅ n·∫øu `getFilteredTodos` ch·∫°y ch·∫≠m ho·∫∑c c√≥ r·∫•t nhi·ªÅu `todos`. Trong tr∆∞·ªùng h·ª£p ƒë√≥, b·∫°n s·∫Ω kh√¥ng mu·ªën t√≠nh l·∫°i `getFilteredTodos()` n√™√∫ state kh√¥ng li√™n quan ki·ªÉu nh∆∞ `newTodo` thay ƒë·ªïi, m√† thay v√†o ƒë√≥ cache (hay ["memoize"](https://en.wikipedia.org/wiki/Memoization) k·∫øt qu·∫£ t√≠nh to√°n l·∫°i, b·∫±ng `useMemo`:

```jsx
import { useMemo, useState } from 'react';

function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  const visibleTodos = useMemo(() => {
    // ‚úÖ Kh√¥ng ch·∫°y l·∫°i tr·ª´ khi todos hay filter thay ƒë·ªïi
    return getFilteredTodos(todos, filter);
  }, [todos, filter]);
  // ...
}
```

Hay ng·∫Øn g·ªçn ch·ªâ v·ªõi 1 d√≤ng:

```jsx
import { useMemo, useState } from 'react';

function TodoList({ todos, filter }) {
  const [newTodo, setNewTodo] = useState('');
  // ‚úÖ Kh√¥ng ch·∫°y l·∫°i tr·ª´ khi todos hay filter thay ƒë·ªïi
  const visibleTodos = useMemo(() => getFilteredTodos(todos, filter), [todos, filter]);
  // ...
}
```

Code tr√™n b·∫£o React kh√¥ng c·∫ßn ch·∫°y alij h√†m b√™n trong `useMemo` tr·ª´ tr∆∞·ªùng h·ª£p `todos` ho·∫∑c `filter` thay ƒë·ªïi. React s·∫Ω ghi nh·ªõ k·∫øt qu·∫£ t√≠nh to√°n t·ª´ `getFilteredTodos()` trong l·∫ßn render kh·ªüi t·∫°o. Nh·ªØng l·∫ßn render sau, n√≥ s·∫Ω ki·ªÉm tra xem `todos` ho·∫∑c `filter` c√≥ kh√°c kh√¥ng. N·∫øu chung v·∫´n gi·ªëng l·∫ßn render tr∆∞·ªõc, `useMemo` s·∫Ω tr·∫£ l·∫°i k·∫øt qu·∫£ tr∆∞·ªõc ƒë√£ ƒë∆∞·ª£c l∆∞u s·∫µn. N·∫øu ch√∫ng kh√°c, React g·ªçi ch·∫°y l·∫°i h√†m b√™n trong, tr·∫£ v·ªÅ ƒë·ªìng th·ªùi l∆∞u l·∫°i k·∫øt qu·∫£ t√≠nh to√°n m·ªõi. L∆∞u √Ω h√†m b√™n trong `useMemo` ph·∫£i l√† [h√†m thu·∫ßn khi·∫øt - pure function](https://beta.reactjs.org/learn/keeping-components-pure).

### Reset to√†n b·ªô state khi prop thay ƒë·ªïi

Component `ProfilePage` nh·∫≠n ƒë∆∞·ª£c prop `userId`. N√≥ bao g·ªìm m·ªôt input ƒë·ªÉ nh·∫≠p b√¨nh lu·∫≠n, l∆∞u trong state `comment`. M·ªôt bu·ªïi s√°ng b·∫°n nh·∫≠n ra khi trang n√†y thay ƒë·ªïi h·ªì s∆° t·ª´ ng∆∞·ªùi n√†y sang ng∆∞·ªùi kh√°c, `comment` kh√¥ng thay ƒë·ªïi. S·∫Ω kh√¥ng d·ªÖ ch·ªãu g√¨ n·∫øu b√¨nh lu·∫≠n c·ªßa ng∆∞·ªùi n√†y l·∫°i ƒë∆∞·ª£c ƒëƒÉng trong h·ªì s∆° c·ªßa m·ªôt ng∆∞·ªùi kh√°c. ƒê·ªÉ s·ª≠a, b·∫°n s·∫Ω xo√° `comment` _m·ªói khi_ `userId` thay ƒë·ªïi:

```jsx
export default function ProfilePage({ userId }) {
  const [comment, setComment] = useState('');

  // üî¥ C·∫ßn tr√°nh: Reset state theo prop trong Effect
  useEffect(() => {
    setComment('');
  }, [userId]);
  // ...
}
```

C√°ch l√†m n√†y kh√¥ng hi·ªáu qu·∫£ b·ªüi `ProfilePage` s·∫Ω render gi√° tr·ªã c≈© tr∆∞·ªõc r·ªìi m·ªõi render l·∫°i. N√≥ c√≤n ph·ª©c t·∫°p n·ªØa b·ªüi b·∫°n s·∫Ω ph·∫£i xo√° state trong m·ªçi component trong `ProfilePage`. V√≠ d·ª•, n√™n UI ph·∫ßn b√¨nh lu·∫≠n c√≥ nhi·ªÅu c·∫•p, b·∫°n c√≥ th·ªÉ ph·∫£i xo√° c·∫£ state b√¨nh lu·∫≠n l·ªìng nhau.

Thay v√†o ƒë√≥, b·∫°n c√≥ th·ªÉ n√≥i React r·∫±ng m·ªói h·ªì s∆° ng∆∞·ªùi d√πng v·ªÅ m·∫∑t kh√°i ni·ªám l√† kh√°c nhau ho√†n to√†n b·∫±ng c√°ch s·ª≠ d·ª•ng `key`. Chia component l√†m hai v√† truy·ªÅn `key` t·ª´ component ngo√†i v√†o component trong:

```jsx
export default function ProfilePage({ userId }) {
  return (
    <Profile
      userId={userId}
      key={userId}
    />
  );
}

function Profile({ userId }) {
  // ‚úÖ State n√†y v√† m·ªçi state ·ªü d∆∞·ªõi s·∫Ω ƒë∆∞·ª£c reset t·ª± ƒë·ªông
  const [comment, setComment] = useState('');
  // ...
}
```

Th√¥ng th∆∞·ªùng, React b·∫£o to√†n state khi component gi·ªëng nhau ƒë∆∞·ª£c render t·∫°i v·ªã tr√≠ gi·ªëng nhau. B·∫±ng c√°ch truy·ªÅn `userId` nh∆∞ `key` v√†o component `Profile`, b·∫°n y√™u c·∫ßu React ƒë·ªëi x·ª≠ `Profile` v·ªõi `userId` kh√°c nhau nh∆∞ nh·ªØng component kh√°c nhau kh√¥ng d√πng chung b·∫•t c·ª© state n√†o. M·ªói khi key thay ƒë·ªïi, React t·∫°o l·∫°i DOM v√† reset to√†n b·ªô state c·ªßa `Profile` v√† c√°c con c·ªßa n√≥. K·∫øt qu·∫£ `comment` ƒë∆∞·ª£c xo√° t∆∞ ƒë·ªông m·ªói khi chuy·ªÉn sang h·ªì s∆° kh√°c.

ƒê√°ng ch√∫ √Ω l√† ch·ªâ `ProfilePage` cha ƒë∆∞·ª£c export trong project. Component n√†o render `ProfilePage` kh√¥ng c·∫ßn ph·∫£i truy·ªÅn key cho n√≥, m√† ch·ªâ truy·ªÅn `userId` nh∆∞ prop b√¨nh th∆∞·ªùng. Vi·ªác `ProfilePage` truy·ªÅn `key` cho `Profile` b√™n trong ch·ªâ l√† c√°ch th·ª±c thi trong n·ªôi b·ªô c·ªßa n√≥ th√¥i.

### ƒêi·ªÅu ch·ªânh m·ªôt s·ªë state theo prop

ƒê√¥i khi, b·∫°n mu·ªën reset ho·∫∑c ƒëi·ªÅu ch·ªânh ch·ªâ m·ªôt s·ªë state, kh√¥ng ph·∫£i to√†n b·ªô, m·ªói khi prop thay ƒë·ªïi.

Component `List` sau ƒë√¢y nh·∫≠n v√†o m·ªôt danh s√°ch `items`, m√† l∆∞u danh s√°ch c√°c item ƒë∆∞·ª£c ch·ªçn b·ªüi ng∆∞·ªùi d√πng v√†o state `selection`. B·∫°n mu·ªën reset `selection` v·ªÅ `null` m·ªói khi `items` nh·∫≠n v√†o m·ªôt m·∫£ng m·ªõi:

```jsx
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  // üî¥ C·∫ßn tr√°nh: ƒêi·ªÅu ch·ªânh state theo prop trong Effect
  useEffect(() => {
    setSelection(null);
  }, [items]);
  // ...
}
```

M·ªói khi `items` thay ƒë·ªïi, `List` v√† c√°c component con s·∫Ω render l·∫°i v·ªõi gi√° tr·ªã c≈© c·ªßa `selection` tr∆∞·ªõc. Sau ƒë√≥ React m·ªõi c·∫≠p nh·∫≠t DOM v√† ch·∫°y Effect. Cu·ªëi c√πng, `setSelection(null)` ƒë∆∞·ª£c g·ªçi khi·∫øn render l·∫°i `List` v√† c√°c component con th√™m m·ªôt l·∫ßn n·ªØa.

C√°ch l√†m ƒë√∫ng l√† xo√° Effect r·ªìi ƒëi·ªÅu ch·ªânh state ngay trong render.


```jsx
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selection, setSelection] = useState(null);

  // T·ªët h∆°n: ƒêi·ªÅu ch·ªânh state ngay khi render
  const [prevItems, setPrevItems] = useState(items);
  if (items !== prevItems) {
    setPrevItems(items);
    setSelection(null);
  }
  // ...
}
```

[L∆∞u tr·ªØ th√¥ng tin t·ª´ l·∫ßn render tr∆∞·ªõc](https://beta.reactjs.org/apis/react/useState#storing-information-from-previous-renders) c√≥ v·∫ª l√† m·ªôt k·ªπ thu·∫≠t kh√≥ hi·ªÉu, nh∆∞ng n√≥ ·ªïn h∆°n so v·ªõi vi·ªác c·∫≠p nh·∫≠t l·∫°i state c≈© trong Effect. Trong v√≠ d·ª• tr√™n, `setSelection` ƒë∆∞·ª£c g·ªçi tr·ª±c ti·∫øp khi render. React s·∫Ω render l·∫°i `List` ngay sau khi `return`. React kh√¥ng render l·∫°i c√°c con c·ªßa `List` v√† c·∫≠p nh·∫≠t DOM ngay, b·ªè qua l·∫ßn render v·ªõi gi√° tr·ªã c≈© c·ªßa `selection`.

Khi b·∫°n c·∫≠p nh·∫≠t m·ªôt component trong render, React v·ª©t b·ªè h·∫øt JSX tr·∫£ v·ªÅ v√† c·ªë g·∫Øng render l·∫°i ngay. ƒê·ªÉ ph√≤ng tr√°nh c√°c l·∫ßn th·ª≠ l·∫°i b·ªã x·∫øp ch·ªìng, React ch·ªâ cho ph√©p b·∫°n c·∫≠p nh·∫≠t state c·ªßa component gi·ªëng nhau trong m·ªói l·∫ßn render. N·∫øu b·∫°n c·∫≠p nh·∫≠t state c·ªßa component kh√°c, b·∫°n s·∫Ω g·∫∑p l·ªói. ƒêi·ªÅu ki·ªán nh∆∞ `items !== prevItems` l√† c·∫ßn thi·∫øt ƒë·ªÉ tr√°nh v√≤ng l·∫∑p. ƒêi·ªÅu ch·ªânh state c√≥ th·ªÉ l√†m nh∆∞ n√†y c√≤n c√°c hi·ªáu ·ª©ng ph·ª• kh√°c nh∆∞ thay ƒë·ªïi DOM hay ƒë·∫∑t h·∫πn gi·ªù n√™n ƒë∆∞·ª£c gi·ªØ trong event handler ho·∫∑c Effect ƒë·ªÉ [gi·ªØ cho component ho·∫°t ƒë·ªông ·ªïn ƒë·ªãnh](https://beta.reactjs.org/learn/keeping-components-pure).

__M·∫∑c d√π pattern n√†y hi·ªáu qu·∫£ h∆°n Effect, ch√∫ng kh√¥ng n√™n ƒë∆∞·ª£c s·ª≠ d·ª•ng nhi·ªÅu__. ƒêi·ªÅu ch·ªânh state d·ª±a tr√™n props ho·∫∑c state kh√°c khi·∫øn lu·ªìng d·ªØ li·ªáu kh√≥ theo d√µi v√† debug. Lu√¥n ki·ªÉm tra r·∫±ng b·∫°n c√≥ th·ªÉ reset to√†n b·ªô state b·∫±ng `key` ho·∫∑c t√≠nh to√°n m·ªçi th·ª© khi render kh√¥ng. Ch·∫≥ng h·∫°n, thay v√¨ l∆∞u (v√† reset) item ƒë∆∞·ª£c ch·ªçn, b·∫°n c√≥ th·ªÉ l∆∞u ID c·ªßa n√≥:

```jsx
function List({ items }) {
  const [isReverse, setIsReverse] = useState(false);
  const [selectedId, setSelectedId] = useState(null);
  // ‚úÖ T·ªët nh·∫•t: T√≠nh to√°n m·ªçi th·ª© ngay trong render
  const selection = items.find(item => item.id === selectedId) ?? null;
  // ...
}
```

Gi·ªù b·∫°n kh√¥ng c·∫ßn ph·∫£i "ƒëi·ªÅu ch·ªânh" state n·ªØa. N·∫øu ID n·∫±m trong danh s√°ch, item t∆∞∆°ng ·ª©ng v·∫´n ƒë∆∞·ª£c ch·ªçn. N·∫øu kh√¥ng, `selection` s·∫Ω b·∫±ng `null`. H√†nh vi n√†y kh√°c bi·ªát ch√∫t √≠t, nh∆∞ng r√µ r√†ng l√† ·ªïn h∆°n v√¨ m·ªçi thay ƒë·ªïi c·ªßa `items` l√∫c n√†y ƒë·ªÅu ph·∫£n √°nh ngay v√†o `selection`. L∆∞u √Ω nh·ªè l√† b·∫°n c·∫ßn s·ª≠ d·ª•ng `selection` trong m·ªçi logic sau ƒë√≥ b·ªüi `selectedId` c√≥ th·ªÉ kh√¥ng t·ªìn t·∫°i.

### Chia s·∫ª logic gi·ªØa nhi·ªÅu event handler

B·∫°n c√≥ m·ªôt trang s·∫£n ph·∫©m v·ªõi 2 n√∫t `Mua` v√† `Gi·ªè h√†ng`, c·∫£ hai ƒë·ªÅu d√πng ƒë·ªÉ mua h√†ng. B·∫°n mu·ªën hi·ªán m·ªôt th√¥ng b√°o _m·ªói khi_ ng∆∞·ªùi d√πng th√™m s·∫£n ph·∫©m v√†o gi·ªè h√†ng. G·ªçi h√†m `showNotification()` trong handler c·ªßa c·∫£ 2 n√∫t c√≥ v·∫ª l·∫∑p l·∫°i, n√™n b·∫°n th·∫•y s·∫Ω h∆°n hay n·∫øu ƒë·∫∑t logic n√†y trong Effect:

```jsx
function ProductPage({ product, addToCart }) {
  // üî¥ C·∫ßn tr√°nh: ƒê·∫∑t logic g·∫Øn li·ªÅn v·ªõi event trong Effect
  useEffect(() => {
    if (product.isInCart) {
      showNotification(`Added ${product.name} to the shopping cart!`);
    }
  }, [product]);

  function handleBuyClick() {
    addToCart(product);
  }

  function handleCheckoutClick() {
    addToCart(product);
    navigateTo('/checkout');
  }
  // ...
}
```

Effect n√†y kh√¥ng ch·ªâ th·ª´a, m√† c√≤n d·ªÖ t·∫°o ra bug. Gi·∫£ d·ª• app c·ªßa b·∫°n c√≥ kh·∫£ nƒÉng "ghi nh·ªõ" gi·ªè h√†ng k·ªÉ c·∫£ t·∫£i l·∫°i c√°c trang. N·∫øu b·∫°n th√™m h√†ng v√†o gi·ªè v√† t·∫£i l·∫°i trang, th√¥ng b√°o s·∫Ω l·∫°i xu·∫•t hi·ªán. ƒêi·ªÅu n√†y b·ªüi `product.isInCart` lu√¥n `true` khi trang t·∫£i, n√™n Effect g·ªçi `showNotification()`.

__Khi b·∫°n kh√¥ng ch·∫Øc ch·∫Øn r·∫±ng code n√†o n√™n n·∫±m trong Effect ho·∫∑c trong h√†m x·ª≠ l√Ω event, h√£y t·ª± h·ªèi _t·∫°i sao_ c·∫ßn ph·∫£i ch·∫°y ƒëo·∫°n code n√†y. Ch·ªâ s·ª≠ d·ª•ng Effect cho ƒëo·∫°n code c·∫ßn ch·∫°y _b·ªüi v√¨_ component ph·∫£i hi·ªÉn th·ªã cho ng∆∞·ªùi d√πng__. Trong v√≠ d·ª• n√†y, th√¥ng b√°o n√™n xu·∫•t hi·ªán b·ªüi v·ªã ng∆∞·ªùi d√πng _nh·∫•n n√∫t_, kh√¥ng ph·∫£i b·ªüi trang ƒë∆∞·ª£c hi·ªÉn th·ªã! Xo√° Effect v√† ƒë∆∞a logic chung v√†o m·ªôt h√†m m√† b·∫°n s·∫Ω g·ªçi t·ª´ c·∫£ hai h√†m x·ª≠ l√Ω event:

```jsx
function ProductPage({ product, addToCart }) {
  // ‚úÖ T·ªët: Logic g·∫Øn li·ªÅn v·ªõi event n·∫±m trong handler
  function buyProduct() {
    addToCart(product);
    showNotification(`Added ${product.name} to the shopping cart!`);
  }

  function handleBuyClick() {
    buyProduct();
  }

  function handleCheckoutClick() {
    buyProduct();
    navigateTo('/checkout');
  }
  // ...
}
```

Effect ƒë∆∞·ª£c xo√° v√† bug ƒë∆∞·ª£c fix.

### G·ª≠i m·ªôt request POST

`Form` sau g·ª≠i hai lo·∫°i request POST. N√≥ g·ª≠i event ƒëo l∆∞·ªùng khi mount. Khi b·∫°n ƒëi·ªÅn xong form v√† nh·∫•n v√†o n√∫t Submit, n√≥ s·∫Ω g·ª≠i m·ªôt request POST t·ªõi `/api/register`:

```jsx
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');

  // ‚úÖ T·ªët: Logic n√†y ch·ªâ ch·∫°y khi component ph·∫£i xu·∫•t hi·ªán
  useEffect(() => {
    post('/analytics/event', { eventName: 'visit_form' });
  }, []);

  // üî¥ C·∫ßn tr√°nh: Logic g·∫Øn v·ªõi event l·∫°i ƒë·∫∑t trong Effect
  const [jsonToSubmit, setJsonToSubmit] = useState(null);
  useEffect(() => {
    if (jsonToSubmit !== null) {
      post('/api/register', jsonToSubmit);
    }
  }, [jsonToSubmit]);

  function handleSubmit(e) {
    e.preventDefault();
    setJsonToSubmit({ firstName, lastName });
  }
  // ...
}
```

H√£y ƒë√°nh gi√° ƒëo·∫°n code b·ªüi c√πng ti√™u chu·∫©n cho v√≠ d·ª• tr∆∞·ªõc.

Request POST ƒëo l∆∞·ªùng n√™n n·∫±m trong Effect, b·ªüi _l√Ω do_ ƒë·ªÉ g·ª≠i s·ª± ki·ªán n√†y l√† s·ª± xu·∫•t hi·ªán c·ªßa `Form`.

Tuy nhi√™n, request POST l√™n `/api/register` th√¨ kh√¥ng ph·∫£i v√¨ s·ª± xu·∫•t hi·ªán c·ªßa form, m√† v√¨ ng∆∞·ªùi d√πng b·∫•m n√∫t g·ª≠i. Do ƒë√≥ xo√° Effect th·ª© 2 ƒëi v√† chuy·ªÉn request n√†y v√†o trong event handler:

```jsx
function Form() {
  const [firstName, setFirstName] = useState('');
  const [lastName, setLastName] = useState('');

  // ‚úÖ T·ªët: Logic n√†y ch·ªâ ch·∫°y khi component ph·∫£i xu·∫•t hi·ªán
  useEffect(() => {
    post('/analytics/event', { eventName: 'visit_form' });
  }, []);

  function handleSubmit(e) {
    e.preventDefault();
    // ‚úÖ T·ªët: Logic g·∫Øn v·ªõi event n·∫±m trong handler
    post('/api/register', { firstName, lastName });
  }
  // ...
}
```

V·∫≠y m·ªói khi b·∫°n c·∫ßn quy·∫øt ƒë·ªãnh xem m·ªôt ƒëo·∫°n logic n·∫±m trong event handler hay Effect, c√¢u h·ªèi ch√≠nh c·∫ßn tr·∫£ l·ªùi l√† _ƒë√¢y l√† lo·∫°i logic g√¨_ t·ª´ g√≥c nh√¨n c·ªßa ng∆∞·ªùi d√πng. N·∫øu ƒëo·∫°n logic ƒë∆∞·ª£c g·ªçi b·ªüi m·ªôt t∆∞∆°ng t√°c x√°c ƒë·ªãnh, ƒë·∫∑t ch√∫ng trong event handler. N·∫øu ch√∫ng ƒë∆∞·ª£c g√¢y ra b·ªüi s·ª± xu·∫•t hi·ªán tr√™n m√†n h√¨nh c·ªßa user, ƒë·∫∑t ch√∫ng trong Effect.

### "Domino" Effect

Xem x√©t ƒëo·∫°n code sau:

```jsx
function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRound] = useState(1);
  const [isGameOver, setIsGameOver] = useState(false);

  // üî¥ C·∫ßn tr√°nh: m·ªôt state thay ƒë·ªïi k√≠ch ho·∫°t m·ªôt chu·ªói Effect
  useEffect(() => {
    if (card !== null && card.gold) {
      setGoldCardCount(c => c + 1);
    }
  }, [card]);

  useEffect(() => {
    if (goldCardCount > 3) {
      setRound(r => r + 1)
      setGoldCardCount(0);
    }
  }, [goldCardCount]);

  useEffect(() => {
    if (round > 5) {
      setIsGameOver(true);
    }
  }, [round]);

  useEffect(() => {
    alert('Good game!');
  }, [isGameOver]);

  function handlePlaceCard(nextCard) {
    if (isGameOver) {
      throw Error('Game already ended.');
    } else {
      setCard(nextCard);
    }
  }
  // ...
```

C√≥ 2 v·∫•n ƒë·ªÅ:

M·ªôt l√†, code n√†y r·∫•t k√©m hi·ªáu qu·∫£: component ph·∫£i render l·∫°i m·ªói khi g·ªçi `set` g√¨ ƒë√≥ th√†nh chu·ªói. Trong tr∆∞·ªùng h·ª£p x·∫•u nh·∫•t, `setCard` ‚Üí render ‚Üí `setGoldCardCount` ‚Üí render ‚Üí `setRound` ‚Üí render ‚Üí `setIsGameOver` ‚Üí render, t·∫°o th√™m 3 l·∫ßn render th·ª´a.

K·ªÉ c·∫£ khi n√≥ kh√¥ng ch·∫≠m, khi code ph√°t tri·ªÉn l√™n, b·∫°n s·∫Ω g·∫∑p nh·ªØng tr∆∞·ªùng h∆°p "chu·ªói" n√†y s·∫Ω kh√¥ng c√≤n ƒë√°p ·ª©ng y√™u c·∫ßu n·ªØa. T∆∞·ªüng t∆∞·ª£ng n·∫øu b·∫°n th√™m t√≠nh nƒÉng quay l·∫°i l·ªãch s·ª≠ t·ª´ng n∆∞·ªõc ƒëi b·∫±ng c√°ch c·∫≠p nh·∫≠t `card` v·ªÅ m·ªôt n∆∞·ªõc ƒëi trong qu√° kh·ª©, d·∫´n ƒë·∫øn k√≠ch ho·∫°t chu·ªói Effect ch·∫°y l·∫°i v√† thay ƒë·ªïi d·ªØ li·ªáu ƒëang hi·ªÉn th·ªã. C√°ch vi·∫øt nh∆∞ v·∫≠y r·∫•t kh√≥ maintain v√† debug.

T·ªët h∆°n l√† b·∫°n n√™n c·ªë g·∫Øng t√≠nh nhi·ªÅu nh·∫•t c√≥ th·ªÉ khi render, v√† ƒëi·ªÅu ch·ªânh state trong event handler:

```jsx
function Game() {
  const [card, setCard] = useState(null);
  const [goldCardCount, setGoldCardCount] = useState(0);
  const [round, setRound] = useState(1);

  // ‚úÖ T√≠nh to√°n m·ªçi th·ª© ngay khi render
  const isGameOver = round > 5;

  function handlePlaceCard(nextCard) {
    if (isGameOver) {
      throw Error('Game already ended.');
    }

    // ‚úÖ T√≠nh to√°n state ti·∫øp theo ngay trong event handler
    setCard(nextCard);
    if (nextCard.gold) {
      if (goldCardCount <= 3) {
        setGoldCardCount(goldCardCount + 1);
      } else {
        setGoldCardCount(0);
        setRound(round + 1);
        if (round === 5) {
          alert('Good game!');
        }
      }
    }
  }

  // ...
```

C·∫ßn nh·ªõ r·∫±ng trong event handler, state ho·∫°t ƒë·ªông gi·ªëng nh∆∞ m·ªôt tr·∫°ng th√°i x√°c ƒë·ªãnh, nghƒ©a l√† k·ªÉ c·∫£ khi b·∫°n g·ªçi `setRound(round + 1)`, th√¨ bi·∫øn `round` v·∫´n ch·ª©a gi√° tr·ªã c≈© khi ng∆∞·ªùi d√πng b·∫•m n√∫t m√† th√¥i. N·∫øu b·∫°n mu·ªën s·ª≠ d·ª•ng gi√° tr·ªã ti·∫øp theo cho t√≠nh to√°n, h√£y t·ª± ƒë·ªãnh nghƒ©a m·ªôt bi·∫øn ki·ªÉu nh∆∞ `const nextRound = round + 1`.

Tuy nhi√™n kh√¥ng ph·∫£i l√∫c n√†o b·∫°n c≈©ng bi·∫øt ch√≠nh x√°c tr·∫°ng th√°i ti·∫øp theo l√† g√¨ trong event handler. Ch·∫≥ng h·∫°n, h√£y t∆∞·ªüng t∆∞·ª£ng m·ªôt form c√≥ nhi·ªÅu dropdown m√† trong ƒë√≥ c√°c tu·ª≥ ch·ªçn c·ªßa dropdown sau ph·ª• thu·ªôc v√†o l·ª±a ch·ªçn t·ª´ dropdown tr∆∞·ªõc (v√≠ d·ª• khi ƒëi·ªÅn t·ªânh - huy·ªán - x√£). L√∫c ·∫•y m√¥ h√¨nh x·∫øp chu·ªói Effect l·∫°i ph√π h·ª£p ƒë·ªÉ ƒë·ªìng b·ªô d·ªØ li·ªáu.

### Kh·ªüi t·∫°o app

M·ªôt s·ªë logic ch·ªâ n√™n ch·∫°y m·ªôt l·∫ßn duy nh·∫•t khi app kh·ªüi t·∫°o. B·∫°n n√™n ƒë·∫∑t ch√∫ng trong Effect ·ªü component cao nh·∫•t.

```jsx
function App() {
  // üî¥ C·∫ßn tr√°nh: Effect ch·ª©a logic ch·ªâ ch·∫°y m·ªôt l·∫ßn duy nh·∫•t
  useEffect(() => {
    loadDataFromLocalStorage();
    checkAuthToken();
  }, []);
  // ...
}
```

Tuy nhi√™n, b·∫°n nhanh ch√≥ng nh·∫≠n ra n√≥ v·∫´n ƒë∆∞·ª£c ch·∫°y hai l·∫ßn ·ªü ch·∫ø ƒë·ªô development. ƒêi·ªÅu n√†y g√¢y ra r·∫Øc r·ªëi - v√≠ d·ª• nh∆∞ n√≥ hu·ª∑ x√°c th·ª±c token khi ch·∫°y hai l·∫ßn. Nh√¨n chung, component n√™n b·ªÅn b·ªâ v·ªõi vi·ªác b·ªã mount l·∫°i. N·∫øu m·ªôt s·ªë logic ch·ªâ ƒë∆∞·ª£c ph√©p ch·∫°y m·ªôt l·∫ßn khi _app kh·ªüi t·∫°o_ ch·ª© kh√¥ng ph·∫£i m·ªôt l·∫ßn khi _app mount_, b·∫°n n√™n d√πng m·ªôt bi·∫øn ƒë·ªÉ gi√°m s√°t vi·ªác kh·ªüi t·∫°o:

```jsx
let didInit = false;

function App() {
  useEffect(() => {
    if (!didInit) {
      didInit = true;
      // ‚úÖ Ch·ªâ ch·∫°y m·ªôt l·∫ßn duy nh·∫•t khi kh·ªüi ƒë·ªông app
      loadDataFromLocalStorage();
      checkAuthToken();
    }
  }, []);
  // ...
}
```

B·∫°n th·∫≠m ch√≠ c√≤n c√≥ th·ªÉ ch·∫°y ch√∫ng trong khi kh·ªüi t·∫°o module v√† tr∆∞·ªõc khi app render:

```jsx
if (typeof window !== 'undefined') { // Ki·ªÉm tra c√≥ ph·∫£i m√¥i tr∆∞·ªùng browser kh√¥ng
  // ‚úÖ Ch·ªâ ch·∫°y m·ªôt l·∫ßn duy nh·∫•t khi kh·ªüi ƒë·ªông app
  checkAuthToken();
  loadDataFromLocalStorage();
}

function App() {
  // ...
}
```

### B√°o hi·ªáu cho component cha khi state thay ƒë·ªïi

B·∫°n c√≥ m·ªôt component `Toggle` v·ªõi state `isOn` c√≥ th·ªÉ `true` ho·∫∑c `false`. B·∫°n mu·ªën b√°o hi·ªáu cho component cha m·ªói khi `Toggle` ƒë·ªïi tr·∫°ng th√°i, v√¨ th·∫ø b·∫°n b·ªôc l·ªô event `onChange` v√† g·ªçi n√≥ t·ª´ Effect:

```jsx
function Toggle({ onChange }) {
  const [isOn, setIsOn] = useState(false);

  // üî¥ C·∫ßn tr√°nh: onChange ch·∫°y mu·ªôn qu√°
  useEffect(() => {
    onChange(isOn);
  }, [isOn, onChange])

  function handleClick() {
    setIsOn(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      setIsOn(true);
    } else {
      setIsOn(false);
    }
  }

  // ...
}
```

`Toggle` c·∫≠p nh·∫≠t state tr∆∞·ªõc, React c·∫≠p nh·∫≠t m√†n h√¨nh. Ti·∫øp ƒë·∫øn React ch·∫°y Effect, g·ªçi `onChange` truy·ªÅn v√†o t·ª´ component cha. L√∫c n√†y component cha l·∫°i c·∫≠p nh·∫≠t state c·ªßa n√≥, d·∫´n ƒë·∫øn m·ªôt l·∫ßn render n·ªØa. S·∫Ω t·ªët h∆°n n·∫øu m·ªçi th·ª© di·ªÖn ra ch·ªâ trong m·ªôt l·∫ßn render.

Xo√° Effect v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i c·ªßa c·∫£ hai component trong c√πng m·ªôt event handler:

```jsx
function Toggle({ onChange }) {
  const [isOn, setIsOn] = useState(false);

  function updateToggle(nextIsOn) {
    // ‚úÖ T·ªët: ch·∫°y m·ªçi c·∫≠p nh·∫≠t ngay trong event khi·∫øn state thay ƒë·ªïi
    setIsOn(nextIsOn);
    onChange(nextIsOn);
  }

  function handleClick() {
    updateToggle(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      updateToggle(true);
    } else {
      updateToggle(false);
    }
  }

  // ...
}
```

V·ªõi c√°ch l√†m n√†y, c·∫£ component `Toggle` v√† cha ƒë·ªÅu update tr·∫°ng th√°i trong event. React [c·∫≠p nh·∫≠t theo l√¥](https://beta.reactjs.org/learn/queueing-a-series-of-state-updates) t·ª´ nhi·ªÅu component kh√°c nhau, n√™n ch·ªâ c√≥ m·ªôt l·∫ßn render di·ªÖn ra.

B·∫°n c≈©ng c√≥ th·ªÉ xo√° lu√¥n state v√† nh·∫≠n `isOn` t·ª´ component cha:

```jsx
// ‚úÖ C≈©ng t·ªët: state cho component cha to√†n quy·ªÅn x·ª≠ l√Ω
function Toggle({ isOn, onChange }) {
  function handleClick() {
    onChange(!isOn);
  }

  function handleDragEnd(e) {
    if (isCloserToRightEdge(e)) {
      onChange(true);
    } else {
      onChange(false);
    }
  }

  // ...
}
```

["ƒê∆∞a state l√™n tr√™n"](https://beta.reactjs.org/learn/sharing-state-between-components) cho ph√©p cha to√†n quy·ªÅn ƒëi·ªÅu khi·ªÉn `Toggle` t·ª´ state c·ªßa cha. ƒêi·ªÅu n√†y c≈©ng c√≥ nghƒ©a l√† component cha s·∫Ω ph·∫£i th√™m nhi·ªÅu logic h∆°n, nh∆∞ng t·ªïng th·ªÉ s·∫Ω c√≥ √≠t state ph·∫£i lo h∆°n. M·ªói khi b·∫°n ƒëang t√¨m c√°ch ƒë·ªìng b·ªô state t·ª´ hai ch·ªó kh√°c nhau, ƒë√≥ l√† d·∫•u hi·ªáu cho th·∫•y c·∫ßn ƒë∆∞a state l√™n tr√™n!

### ƒê∆∞a d·ªØ li·ªáu cho component cha

Component `Child` g·ªçi v·ªÅ d·ªØ li·ªáu v√† mu·ªën truy·ªÅn d·ªØ li·ªáu ƒë√≥ cho component cha:

```jsx
function Parent() {
  const [data, setData] = useState(null);
  // ...
  return <Child onFetched={setData} />;
}

function Child({ onFetched }) {
  const data = useSomeAPI();
  // üî¥ C·∫ßn tr√°nh: truy·ªÅn d·ªØ li·ªáu t·ª´ con l√™n cha trong Effect
  useEffect(() => {
    if (data) {
      onFetched(data);
    }
  }, [onFetched, data]);
  // ...
}
```

Trong React, d·ªØ li·ªáu ch·∫£y t·ª´ component cha ƒë·∫øn c√°c con. Khi g·∫∑p l·ªói, b·∫°n c√≥ th·ªÉ m√≤ ƒë∆∞·ª£c th√¥ng tin l·ªói ƒë·∫øn t·ª´ ƒë√¢u b·∫±ng c√°ch ƒëi ng∆∞·ª£c d·∫ßn l√™n theo chu·ªói component cho t·ªõi khi b·∫°n t√¨m ƒë∆∞·ª£c "th·ªß ph·∫°m" truy·ªÅn sai prop ho·∫∑c l·ªói state. N·∫øu b·∫°n d√πng Effect ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu cho cha t·ª´ con, lu·ªìng d·ªØ li·ªáu tr·ªü n√™n r·∫•t kh√≥ theo d√µi. N·∫øu c·∫£ con v√† cha ƒë·ªÅu c·∫ßn c√πng m·ªôt d·ªØ li·ªáu, t·ªët nh·∫•t h√£y ƒë·ªÉ cha l·∫•y d·ªØ li·ªáu v√† truy·ªÅn cho con:

```jsx
function Parent() {
  const data = useSomeAPI();
  // ...
  // ‚úÖ T·ªët: d·ªØ li·ªáu truy·ªÅn t·ª´ cha xu·ªëng con
  return <Child data={data} />;
}

function Child({ data }) {
  // ...
}
```

### ƒêƒÉng k√Ω theo d√µi ngu·ªìn b√™n ngo√†i

Nhi·ªÅu khi component c√≥ th·ªÉ c·∫ßn ƒëƒÉng k√Ω m·ªôt ngu·ªìn d·ªØ li·ªáu n√†o ƒë√≥ n·∫±m ngo√†i state React, nh∆∞ m·ªôt th∆∞ vi·ªán b√™n th·ª© ba ho·∫∑c API c·ªßa browser. Ngu·ªìn d·ªØ li·ªáu n√†y c√≥ th·ªÉ thay ƒë·ªïi tu·ª≥ √Ω m√† React kh√¥ng bi·∫øt, ƒë√≤i h·ªèi b·∫°n s·ª≠ d·ª•ng Effect ƒë·ªÉ theo d√µi ngu·ªìn d·ªØ li·ªáu:


```jsx
function useOnlineStatus() {
  // Kh√¥ng t·ªët: vi·∫øt h√†m theo d√µi th·ªß c√¥ng
  const [isOnline, setIsOnline] = useState(true);
  useEffect(() => {
    function updateState() {
      setIsOnline(navigator.onLine);
    }

    updateState();

    window.addEventListener('online', updateState);
    window.addEventListener('offline', updateState);
    return () => {
      window.removeEventListener('online', updateState);
      window.removeEventListener('offline', updateState);
    };
  }, []);
  return isOnline;
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

M·∫∑c d√π c√°ch l√†m n√†y t∆∞∆°ng ƒë·ªëi ph·ªï bi·∫øn, React trang b·ªã s·∫µn cho ch√∫ng ta m·ªôt Hook chuy√™n tr√°ch cho c√¥ng vi·ªác ƒëƒÉng k√Ω ngu·ªìn d·ªØ li·ªáu ngo√†i. Xo√° Effect ƒëi v√† thay th·∫ø b·∫±ng `useSyncExternalStore`:

```jsx
function subscribe(callback) {
  window.addEventListener('online', callback);
  window.addEventListener('offline', callback);
  return () => {
    window.removeEventListener('online', callback);
    window.removeEventListener('offline', callback);
  };
}

function useOnlineStatus() {
  // ‚úÖ T·ªët: ƒëƒÉng k√Ω theo d√µi ngu·ªìn b√™n ngo√†i v·ªõi Hook h·ªó tr·ª£ s·∫µn b·ªüi React
  return useSyncExternalStore(
    subscribe, // React kh√¥ng ƒëƒÉng k√Ω l·∫°i tr·ª´ phi b·∫°n truy·ªÅn h√†m kh√°c
    () => navigator.onLine, // H√†m n√†y ch·∫°y ·ªü client
    () => true // H√†m n√†y ch·∫°y v·ªõi server
  );
}

function ChatIndicator() {
  const isOnline = useOnlineStatus();
  // ...
}
```

### T·∫£i v·ªÅ d·ªØ li·ªáu

R·∫•t nhi·ªÅu app s·ª≠ d·ª•ng Effect ƒë·ªÉ kh·ªüi ƒë·ªông t·∫£i v·ªÅ d·ªØ li·ªáu, ƒëi·ªÉn h√¨nh nh∆∞ sau:

```jsx
function SearchResults({ query }) {
  const [results, setResults] = useState([]);
  const [page, setPage] = useState(1);

  useEffect(() => {
    // üî¥ C·∫ßn tr√°nh: K√©o d·ªØ li·ªáu m√† qu√™n d·ªçn d·∫πp
    fetchResults(query, page).then(json => {
      setResults(json);
    });
  }, [query, page]);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}
```

ƒêo·∫°n code tr√™n c√≥ bug. T∆∞·ªüng t∆∞·ª£ng b·∫°n nh·∫≠p nhanh t√¨m ki·∫øm `"hello"`. `query` s·∫Ω thay ƒë·ªïi t·ª´ `"h"`, th√†nh `"he"`, `"hel"`, `"hell"`, v√† `"hello"`. M·ªói thay ƒë·ªïi s·∫Ω kh·ªüi ƒë·ªông vi·ªác g·ªçi d·ªØ li·ªáu cho ri√™ng m√¨nh, nh∆∞ng kh√¥ng c√≥ g√¨ ƒë·∫£m b·∫£o c√°c response s·∫Ω v·ªÅ theo ƒë√∫ng th·ª© t·ª± ƒë√≥. Ch·∫≥ng h·∫°n, response cho `"hell"` c√≥ th·ªÉ v·ªÅ sau response c·ªßa `"hello"`, d·∫´n ƒë·∫øn hi·ªÉn th·ªã sai k·∫øt qu·∫£ t√¨m ki·∫øm. ƒê√¢y l√† m·ªôt d·∫°ng [`"race condition"`](https://en.wikipedia.org/wiki/Race_condition): hai request kh√°c nhau ch·∫°y ƒëua v√† k·∫øt qu·∫£ tr·∫£ v·ªÅ theo th·ª© t·ª± kh√°c v·ªõi nh·ªØng g√¨ b·∫°n mong ƒë·ª£i.

ƒê·ªÉ kh·∫Øc ph·ª•c, b·∫°n c·∫ßn th√™m m·ªôt h√†m d·ªçn d·∫πp ƒë·ªÉ ph·ªõt l·ªù nh·ªØng response c≈©:

```jsx
function SearchResults({ query }) {
  const [results, setResults] = useState([]);
  const [page, setPage] = useState(1);
  useEffect(() => {
    let ignore = false;
    fetchResults(query, page).then(json => {
      if (!ignore) {
        setResults(json);
      }
    });
    return () => {
      ignore = true;
    };
  }, [query, page]);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}
```

X·ª≠ l√Ω race condition kh√¥ng ch·ªâ l√† th√°ch th·ª©c duy nh·∫•t khi th·ª±c h√†nh t·∫£i v·ªÅ d·ªØ li·ªáu. B·∫°n ph·∫£i t√≠nh ƒë·∫øn cache d·ªØ li·ªáu tr·∫£ v·ªÅ ra sao (ƒë·ªÉ ng∆∞·ªùi d√πng c√≥ th·ªÉ nh·∫•n Back v√† th·∫•y ngay m√†n h√¨nh tr∆∞·ªõc ƒë√≥ thay v√¨ bi·ªÉu t∆∞·ª£ng xoay xoay), l√†m sao ƒë·ªÉ g·ªçi d·ªØ li·ªáu ph√≠a server (ƒë·ªÉ render ƒë∆∞·ª£c HTML thay v√¨ bi·ªÉu t∆∞·ª£ng xoay xoay), v√† l√†m sao ƒë·ªÉ ph√≤ng ng·ª´a th√°c ƒë·ªï d·ªØ li·ªáu (network waterfall - component con ph·∫£i ch·ªù t·∫•t c·∫£ cha c·ªßa n√≥ k√©o d·ªØ li·ªáu xong m·ªõi ƒë·∫øn l∆∞·ª£t n√≥). __Nh·ªØng v·∫•n ƒë·ªÅ tr√™n xu·∫•t hi·ªán v·ªõi m·ªçi th∆∞ vi·ªán UI__ ch·ª© kh√¥ng ri√™ng g√¨ React. Gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ n√†y kh√¥ng d·ªÖ d√†ng g√¨, v√¨ th·∫ø c√°c framework hi·ªán ƒë·∫°i th∆∞·ªùng cung c·∫•p s·∫µn c∆° ch·∫ø g·ªçi v·ªÅ d·ªØ li·ªáu thay v√¨ vi·∫øt Effect ngay trong component.

N·∫øu b·∫°n kh√¥ng s·ª≠ dung framework (v√† kh√¥ng mu·ªën t·ª± build m·ªôt c√°i) m√† v·∫´n mu·ªën g·ªçi v·ªÅ d·ªØ li·ªáu m·ªôt c√°ch th√¢n thi·ªán v√† hi·ªáu qu·∫£, tham kh·∫£o custom Hook sau ƒë√¢y:

```jsx
function SearchResults({ query }) {
  const [page, setPage] = useState(1);
  const params = new URLSearchParams({ query, page });
  const results = useData(`/api/search?${params}`);

  function handleNextPageClick() {
    setPage(page + 1);
  }
  // ...
}

function useData(url) {
  const [data, setData] = useState(null);
  useEffect(() => {
    let ignore = false;
    fetch(url)
      .then(response => response.json())
      .then(json => {
        if (!ignore) {
          setData(json);
        }
      });
    return () => {
      ignore = true;
    };
  }, [url]);
  return data;
}
```

B·∫°n s·∫Ω ph·∫£i th√™m logic ƒë·ªÉ x·ª≠ l√Ω l·ªói v√† theo d√µi n·ªôi dung ƒë√£ t·∫£i xong hay ch∆∞a. D√π gi·∫£i ph√°p n√†y ch∆∞a ho√†n h·∫£o, nh∆∞ng ƒë∆∞a logic k√©o v·ªÅ d·ªØ li·ªáu ra ri√™ng m·ªôt custom Hook gi√∫p ta tu·ª≥ bi·∫øn chi·∫øn thu·∫≠t k√©o v·ªÅ d·ªØ li·ªáu m·ªôt c√°ch d·ªÖ d√†ng v√† hi·ªáu qu·∫£ h∆°n.

Nh√¨n chung, m·ªói khi b·∫°n ƒë·ªãnh vi·∫øt Effect, h√£y ki·ªÉm tra xem ƒëo·∫°n logic d√πng Effect ƒë√≥ c√≥ th·ªÉ t√°ch ra ri√™ng m·ªôt custom Hook nh∆∞ `useData` ·ªü tr√™n kh√¥ng. C√†ng √≠t vi·∫øt `useEffect` tr·ª±c ti·∫øp trong component, app c·ªßa b·∫°n c√†ng d·ªÖ ƒë·ªÉ maintain.

## T·ªïng k·∫øt

* N·∫øu c√≥ th·ªÉ t√≠nh to√°n trong ngay trong render, b·∫°n kh√¥ng c·∫ßn ƒë·∫øn Effect.
* ƒê·ªÉ cache c√°c t√≠nh to√°n t·ªën k√©m, d√πng `useMemo` thay v√¨ `useEffect`.
* ƒê·ªÉ reset to√†n b·ªô state c·ªßa m·ªôt component, thay ƒë·ªïi `key` c·ªßa n√≥.
* ƒê·ªÉ thay ƒë·ªïi m·ªôt v√†i state theo prop, h√£y thay ƒë·ªïi ngay khi render.
* Code c·∫ßn ch·∫°y v√¨ m·ªôt component ph·∫£i xu·∫•t hi·ªán tr√™n m√†n h√¨nh th√¨ n√™n ƒë·∫∑t trong Effect, c√≤n l·∫°i n√™n ƒë·∫∑t trong event handler.
* N·∫øu c·∫ßn c·∫≠p nh·∫≠t state c·ªßa nhi·ªÅu component c√πng l√∫c, t·ªët h∆°n c·∫£ l√† gom h·∫øt v√†o m·ªôt event.
* B·∫•t c·ª© l√∫c n√†o c·ªë g·∫Øng ƒë·ªìng b·ªô state gi·ªØa nhi·ªÅu component, c√¢n nh·∫Øc ƒë·∫©y state l√™n tr√™n.
* B·∫°n c√≥ th·ªÉ k√©o v·ªÅ d·ªØ li·ªáu v·ªõi Effect, nh∆∞ng nh·ªõ d·ªçn d·∫πp ƒë·ªÉ tr√°nh race condition.

---

## T√†i li·ªáu tham kh·∫£o

Reactjs ƒëang vi·∫øt l·∫°i trang t√†i li·ªáu ch√≠nh th·ª©c. M·ªôt v√†i ƒëi·ªÉm ƒë√°ng ch√∫ √Ω v·ªÅ n·ªôi dung m·ªõi:

* T·∫•t c·∫£ di·ªÖn gi·∫£i __s·ª≠ d·ª•ng Hook__ thay cho class.
* TƒÉng graphic tr·ª±c quan v√† v√≠ d·ª• t∆∞∆°ng t√°c.
* C√≥ c√¢u h·ªèi (k√®m l·ªùi gi·∫£i!) ƒë·ªÉ ki·ªÉm tra m·ª©c ƒë·ªô hi·ªÉu b√†i c·ªßa ƒë·ªôc gi·∫£.

·ªû th·ªùi ƒëi·ªÉm nƒÉm 2022, [b·∫£n beta c·ªßa t√†i li·ªáu m·ªõi t·∫°i ƒë√¢y](https://beta.reactjs.org/).

B√†i vi·∫øt n√†y d·ª±a ph·∫ßn l·ªõn tr√™n b·∫£n g·ªëc [You Might Not Need an Effect](https://beta.reactjs.org/learn/you-might-not-need-an-effect).
